worker_processes  auto;

events {
    worker_connections  1024;
}

http {
    server {
        listen 80;
        server_name _;

        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl;
        server_name _;

        # Allow special characters in headers
        ignore_invalid_headers off;
        # Allow any size file to be uploaded.
        # Set to a value such as 1000m; to restrict file size to a specific value
        client_max_body_size 0;
        # Disable buffering
        proxy_buffering off;
        proxy_request_buffering off;

        ssl_certificate /etc/nginx/certs/domain.crt;
        ssl_certificate_key /etc/nginx/certs/domain.key;

        set $openldr_apisix_gateway "openldr-apisix:9080";
        set $openldr_apisix_admin "openldr-apisix:9180";
        set $openldr_apisix_dashboard "openldr-apisix-dashboard:9000";
        set $keycloak "openldr-keycloak:8443";
        set $openldr_web "openldr-web:3000";

        set $openldr_minio "openldr-minio:9000";
        set $openldr_minio_console "openldr-minio:9001";

        set $openldr_opensearch "openldr-opensearch:9200";
        set $openldr_opensearch_dashboard "openldr-opensearch-dashboard:5601";

        set $openldr_redis "openldr-redis:6379";
        set $openldr_redis_console "openldr-redis-insight:5540";

        set $openldr_kafka "openldr-kafka1:9092";
        set $openldr_kafka_connect "openldr-kafka-connect:8083";
        set $openldr_kafka_conduktor_console "openldr-kafka-conduktor-console:8080";

        set $openldr_data_processing "openldr-data-processing:3001";
        # set $openldr_validation "openldr-validation:3008";
        # set $openldr_mapper "openldr-mapper:3004";
        # set $openldr_external_storage "openldr-external-storage:3003";
        set $openldr_entity_services "openldr-entity-services:3002";
        set $openldr_terminology_mapping "openldr-terminology-mapping:3007";
        set $openldr_plugins "openldr-plugins:3006";

        set $openldr_oclapi "openconceptlab-api:8000";
        set $openldr_oclweb "openconceptlab-web:4000";

        #For demo purposes: DISA
        location /disa-api-proxy/ {
            proxy_pass http://104.248.80.240:3999/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        #For demo purposes: OCL
        location /ocl-api-proxy/ {
            proxy_pass http://188.166.96.39:8000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /oclapi/ {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/oclapi/(.*)$ /$1 break;
            proxy_pass http://$openldr_oclapi;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_read_timeout 900;
        }

        location = /oclapi {
            return 301 /oclapi/;
        }

        location /oclweb {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/oclweb/(.*)$ /$1 break;
            proxy_pass http://$openldr_oclweb;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_read_timeout 900;
        }

        location /redis {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/redis/(.*)$ /$1 break;
            proxy_pass http://$openldr_redis;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_read_timeout 900;
        }

        location /redis-dashboard {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/redis-dashboard/(.*)$ /redis-dashboard/$1 break;
            proxy_pass http://$openldr_redis_console;
            
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_read_timeout 900;
        }

        location /opensearch {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/opensearch/(.*)$ /$1 break;
            proxy_pass http://$openldr_opensearch;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_read_timeout 900;
        }

        location /opensearch-dashboard/ {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/opensearch-dashboard/(.*)$ /$1 break;
            proxy_pass http://$openldr_opensearch_dashboard;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_read_timeout 900;
        }

        location /minio {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/minio/(.*)$ /$1 break;
            proxy_pass http://$openldr_minio;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_read_timeout 900;
        }

        location /minio-console/ {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/minio-console/(.*)$ /$1 break;
            
            proxy_pass http://$openldr_minio_console;
            
            # Essential headers for MinIO console
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Timeouts
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
            proxy_read_timeout 300;
            
            # Disable chunked transfer encoding
            chunked_transfer_encoding off;
        }

        location = /minio-console {
            return 301 /minio-console/;
        }

        location /plugins {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/plugins/(.*)$ /$1 break;
            proxy_pass http://$openldr_plugins;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_read_timeout 900;
        }

        location /terminology-mapping {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/terminology-mapping/(.*)$ /$1 break;
            proxy_pass http://$openldr_terminology_mapping;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_read_timeout 900;
        }

        location /entity-services {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/entity-services/(.*)$ /$1 break;
            proxy_pass http://$openldr_entity_services;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_read_timeout 900;
        }

        location /data-processing {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/data-processing/(.*)$ /$1 break;
            proxy_pass http://$openldr_data_processing;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_read_timeout 900;
        }

        location /kafka {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/kafka/(.*)$ /$1 break;
            proxy_pass http://$openldr_kafka;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_read_timeout 900;
        }

        location /kafka-connect {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/kafka-connect/(.*)$ /$1 break;
            proxy_pass http://$openldr_kafka_connect;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_read_timeout 900;
        }

        location /kafka-console/ {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/kafka-console/(.*)$ /kafka-console/$1 break;
            proxy_pass http://$openldr_kafka_conduktor_console;
                        
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_read_timeout 900;
        }

        location = /kafka-console {
            return 301 /kafka-console/;
        }

        location /apisix-gateway {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/apisix-gateway/(.*)$ /$1 break;
            proxy_pass http://$openldr_apisix_gateway;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_read_timeout 900;
        }

        location /apisix-admin {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/apisix-admin/(.*)$ /$1 break;
            proxy_pass http://$openldr_apisix_admin;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_read_timeout 900;
        }

        location /apisix-dashboard {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/apisix-dashboard/(.*)$ /apisix-dashboard/$1 break;
            proxy_pass http://$openldr_apisix_dashboard;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_read_timeout 900;
        }


        location /web {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/web/(.*)$ /web/$1 break;
            proxy_pass http://$openldr_web;

            client_max_body_size 100m;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
            proxy_read_timeout 900;
        }


        location /keycloak/ {
            resolver 127.0.0.11 valid=10s ipv6=off;
            rewrite ^/keycloak/(.*)$ /keycloak/$1 break;
            proxy_pass https://$keycloak;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
        }

    }
}